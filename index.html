<!DOCTYPE html><html lang="pt-BR"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Nunes Mec√¢nica Automotiva</title>
  <link rel="stylesheet" href="style.css">
  <link rel="shortcut icon" href="logonunes.png" type="image/png">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,700&amp;display=swap">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <style>
    .logo-upload.hide { display: none; }
    .autocomplete-items {
      position: absolute;
      border: 1px solid #d4d4d4;
      z-index: 99;
      background: #fff;
      width: 100%;
      max-height: 170px;
      overflow-y: auto;
      border-radius: 0 0 5px 5px;
    }
    .autocomplete-items div {
      padding: 7px 10px;
      cursor: pointer;
      border-bottom: 1px solid #f1f1f1;
    }
    .autocomplete-items div:hover {
      background-color: #f1f1f1;
    }
  </style>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="sidebar-logo">
        <img id="sidebar-logo-img" src="" alt="Logo Auto Mec√¢nica Nunes" class="logo-preview">
      </div>
      <div class="logo-upload">
        <label for="logo-upload-input" style="cursor:pointer;">
          <span>Seu logo:</span>
          <input type="file" id="logo-upload-input" accept="image/png,image/jpeg">
        </label>
        <div style="color:#fff;font-size:0.9em;">(PNG/JPG at√© 200kb)</div>
      </div>
      <nav>
        <ul>
          <li><button onclick="nav('orcamentos')" id="nav-orcamentos" class="active">üí≥ Or√ßamentos</button></li>
          <li><button onclick="nav('os')" id="nav-os">üîß Ordens de Servi√ßo</button></li>
          <li><button onclick="nav('clientes')" id="nav-clientes">üë§ Clientes</button></li>
          <li><button onclick="nav('estoque')" id="nav-estoque">üì¶ Estoque</button></li>
          <li><button onclick="nav('relatorio')" id="nav-relatorio">üìä Relat√≥rio OS</button></li>
        </ul>
      </nav>
    </aside>
    <main class="main">
      <header>
        <h1 id="main-title">Or√ßamentos</h1>
      </header>
      
      <!-- Or√ßamentos -->
      <section id="page-orcamentos">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <button class="btn btn-success" onclick="showOrcamentoForm()">+ Novo Or√ßamento</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Cliente</th>
                <th>Ve√≠culo</th>
                <th>Itens</th>
                <th>Valor Total</th>
                <th>Status</th>
                <th>Validade</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="orc-table"></tbody>
          </table>
        </div>
        <div id="orc-form-wrap" class="hide">
          <h3 id="orc-form-title">Novo Or√ßamento</h3>
          <form onsubmit="salvarOrcamento(event)">
            <input type="hidden" id="orc-form-id">
            <div class="flex-row">
              <div style="flex:1" class="flex-col">
                <label>Cliente</label>
                <select id="orc-form-cliente" required="" onchange="popularVeiculosOrcamento()">
                  <option value="">Selecione</option>
                </select>
              </div>
              <div style="flex:1" class="flex-col">
                <label>Ve√≠culo</label>
                <select id="orc-form-veiculo" required="">
                  <option value="">Selecione um cliente primeiro</option>
                </select>
              </div>
            </div>

            <label>Itens do Or√ßamento</label>
            <div>
              <div class="autocomplete-wrapper" style="width:100%;">
                <input type="text" id="orc-item-nome" placeholder="Descri√ß√£o do item (ou pesquise pe√ßa do estoque)" style="flex:2;" autocomplete="off">
                <input type="number" id="orc-item-valor" placeholder="Valor (R$)" style="flex:1;">
                <input type="number" id="orc-item-qtd" placeholder="Qtd" min="1" style="width:70px;">
                <button type="button" class="btn btn-sm btn-outline" onclick="adicionarItemOrcamento()">Adicionar</button>
              </div>
              <div id="orc-itens-list"></div>
            </div>
            <label>Valor Total</label>
            <input type="number" id="orc-form-valor" required="" placeholder="R$" readonly="">

            <label>Status</label>
            <select id="orc-form-status">
              <option>Pendente</option>
              <option>Aprovado</option>
              <option>Reprovado</option>
              <option>Expirado</option>
            </select>
            <label>Validade</label>
            <input type="date" id="orc-form-validade" required="">
            <label>Observa√ß√µes</label>
            <textarea id="orc-form-obs" placeholder="Notas adicionais"></textarea>
            <div class="form-actions">
              <button class="btn btn-success" type="submit">Salvar Or√ßamento</button>
              <button class="btn btn-outline" onclick="hideOrcamentoForm();return false;">Cancelar</button>
            </div>
          </form>
        </div>
      </section>

      <!-- OS -->
      <section id="page-os" class="hide">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <button class="btn btn-success" onclick="showOSForm()">+ Nova OS</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Cliente</th>
                <th>Ve√≠culo</th>
                <th>Servi√ßos/Pe√ßas</th>
                <th>Valor Total</th>
                <th>Forma Pagamento</th>
                <th>Status</th>
                <th>Entrada</th>
                <th>Sa√≠da Prevista</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="os-table"></tbody>
          </table>
        </div>
        <div id="os-form-wrap" class="hide">
          <h3 id="os-form-title">Nova Ordem de Servi√ßo</h3>
          <form onsubmit="salvarOS(event)">
            <input type="hidden" id="os-form-id">
            <div class="flex-row">
              <div style="flex:1" class="flex-col">
                <label>Cliente</label>
                <select id="os-form-cliente" required="" onchange="popularVeiculosOS()">
                  <option value="">Selecione</option>
                </select>
              </div>
              <div style="flex:1" class="flex-col">
                <label>Ve√≠culo</label>
                <select id="os-form-veiculo" required="">
                  <option value="">Selecione um cliente primeiro</option>
                </select>
              </div>
            </div>
            <label>Servi√ßos/Pe√ßas</label>
            <div>
              <div class="autocomplete-wrapper" style="width:100%;">
                <input type="text" id="os-item-nome" placeholder="Servi√ßo ou pe√ßa do estoque" style="flex:2;" autocomplete="off">
                <input type="number" id="os-item-valor" placeholder="Valor (R$)" style="flex:1;">
                <input type="number" id="os-item-qtd" placeholder="Qtd" min="1" style="width:70px;">
                <button type="button" class="btn btn-sm btn-outline" onclick="adicionarItemOS()">Adicionar</button>
              </div>
              <div id="os-itens-list"></div>
            </div>
            <label>Valor Total</label>
            <input type="number" id="os-form-valor" required="" placeholder="R$" readonly="">
            <label>Forma de Pagamento</label>
            <select id="os-form-pagamento" required="">
              <option value="">Selecione</option>
              <option>Dinheiro</option>
              <option>Cart√£o de Cr√©dito</option>
              <option>Cart√£o de D√©bito</option>
              <option>Pix</option>
              <option>Boleto</option>
            </select>
            <label>Data Entrada</label>
            <input type="date" id="os-form-entrada" required="">
            <label>Data Sa√≠da Prevista</label>
            <input type="date" id="os-form-saida" required="">
            <label>Status</label>
            <select id="os-form-status" required="">
              <option>Em andamento</option>
              <option>Finalizado</option>
              <option>Aguardando pe√ßa</option>
              <option>Aguardando aprova√ß√£o</option>
              <option>Entregue</option>
            </select>
            <div class="form-actions">
              <button class="btn btn-success" type="submit">Salvar OS</button>
              <button class="btn btn-outline" onclick="hideOSForm();return false;">Cancelar</button>
            </div>
          </form>
        </div>
      </section>

      <!-- Clientes -->
      <section id="page-clientes" class="hide">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <button class="btn btn-success" onclick="showClienteForm()">+ Novo Cliente</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Telefone</th>
                <th>Email</th>
                <th>Ve√≠culos</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="clientes-table"></tbody>
          </table>
        </div>
        <div id="cliente-form-wrap" class="hide">
          <h3 id="cliente-form-title">Novo Cliente</h3>
          <form onsubmit="salvarCliente(event)">
            <input type="hidden" id="cli-id">
            <div class="flex-row">
              <div style="flex:1" class="flex-col">
                <label>Nome</label>
                <input type="text" id="cli-nome" required="">
                <label>Telefone</label>
                <input type="tel" id="cli-telefone">
                <label>Email</label>
                <input type="email" id="cli-email">
              </div>
              <div style="flex:1" class="flex-col">
                <label>Adicionar Ve√≠culo</label>
                <input type="text" id="cli-veiculo-marca" placeholder="Marca/Modelo">
                <input type="text" id="cli-veiculo-placa" placeholder="Placa">
                <input type="number" id="cli-veiculo-ano" placeholder="Ano">
                <input type="text" id="cli-veiculo-cor" placeholder="Cor">
                <button type="button" class="btn btn-sm btn-outline" onclick="adicionarVeiculo()">Adicionar √† lista</button>
                <div id="veiculos-adicionados"></div>
              </div>
            </div>
            <div class="form-actions">
              <button class="btn btn-success" type="submit">Salvar Cliente</button>
              <button class="btn btn-outline" onclick="hideClienteForm();return false;">Cancelar</button>
            </div>
          </form>
        </div>
      </section>
      
      <!-- ESTOQUE -->
      <section id="page-estoque" class="hide">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <button class="btn btn-success" onclick="showEstoqueForm()">+ Nova Pe√ßa</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>C√≥digo</th>
                <th>Descri√ß√£o</th>
                <th>Quantidade</th>
                <th>Pre√ßo Unit.</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="estoque-table"></tbody>
          </table>
        </div>
        <div id="estoque-form-wrap" class="hide">
          <h3 id="estoque-form-title">Nova Pe√ßa</h3>
          <form onsubmit="salvarPecaEstoque(event)">
            <input type="hidden" id="estoque-form-id">
            <label>Nome da Pe√ßa</label>
            <input type="text" id="estoque-form-nome" required="">
            <label>C√≥digo</label>
            <input type="text" id="estoque-form-codigo" required="">
            <label>Descri√ß√£o</label>
            <input type="text" id="estoque-form-desc">
            <label>Quantidade</label>
            <input type="number" id="estoque-form-qtd" required="" min="0">
            <label>Pre√ßo Unit√°rio (R$)</label>
            <input type="number" id="estoque-form-preco" required="" step="0.01" min="0">
            <div class="form-actions">
              <button class="btn btn-success" type="submit">Salvar</button>
              <button class="btn btn-outline" onclick="hideEstoqueForm();return false;">Cancelar</button>
            </div>
          </form>
        </div>
      </section>

      <!-- Relat√≥rio -->
      <section id="page-relatorio" class="hide">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
          <div>
            <label for="filtro-pagamento" style="display:block;margin-bottom:.2em;">Filtrar por pagamento:</label>
            <select id="filtro-pagamento" onchange="renderRelatorio()">
              <option value="">Todas</option>
              <option>Dinheiro</option>
              <option>Cart√£o de Cr√©dito</option>
              <option>Cart√£o de D√©bito</option>
              <option>Pix</option>
              <option>Boleto</option>
            </select>
          </div>
          <button class="btn btn-success" style="margin-top:1em;" onclick="baixarPDF()">Baixar PDF</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Cliente</th>
                <th>Ve√≠culo</th>
                <th>Valor</th>
                <th>Forma Pagamento</th>
                <th>Status</th>
                <th>Entrada</th>
                <th>Sa√≠da</th>
              </tr>
            </thead>
            <tbody id="relatorio-table"></tbody>
          </table>
        </div>
      </section>
      <div id="notif" class="notif hide"></div>
    </main>
  </div>

  <script>
    // ====== DADOS E FUN√á√ïES GERAIS ======
    function loadData() {
      window.clientes = JSON.parse(localStorage.getItem("oficina_clientes") || "[]");
      window.osList = JSON.parse(localStorage.getItem("oficina_os") || "[]");
      window.orcList = JSON.parse(localStorage.getItem("oficina_orc") || "[]");
      window.estoque = JSON.parse(localStorage.getItem("oficina_estoque") || "[]");
      if (!window.clientes.length) {
        window.clientes = [
          {
            id: 1,
            nome: "Jo√£o Silva",
            telefone: "(11) 99999-0000",
            email: "joao@email.com",
            veiculos: [
              { marca: "Ford Fiesta", placa: "ABC-1234", ano: 2016, cor: "Preto" },
              { marca: "Toyota Corolla", placa: "DEF-5678", ano: 2018, cor: "Prata" }
            ]
          },
          {
            id: 2,
            nome: "Maria Souza",
            telefone: "(11) 98888-1111",
            email: "maria@email.com",
            veiculos: [
              { marca: "Honda Fit", placa: "XYZ-8899", ano: 2015, cor: "Vermelho" }
            ]
          }
        ];
        saveData();
      }
    }
    function saveData() {
      localStorage.setItem("oficina_clientes", JSON.stringify(window.clientes));
      localStorage.setItem("oficina_os", JSON.stringify(window.osList));
      localStorage.setItem("oficina_orc", JSON.stringify(window.orcList));
      localStorage.setItem("oficina_estoque", JSON.stringify(window.estoque));
    }
    function gerarId(lista) { return (lista.length ? Math.max(...lista.map(e => e.id || 0)) : 0) + 1; }
    function notificar(msg) {
      const n = document.getElementById('notif');
      n.textContent = msg;
      n.classList.remove('hide');
      setTimeout(() => n.classList.add('hide'), 1800);
    }

    // ====== LOGO ======
    function getLogoBase64() {
      return localStorage.getItem('oficina_logo_base64') || "";
    }
    function setLogoBase64(base64) {
      localStorage.setItem('oficina_logo_base64', base64 || "");
      document.getElementById('sidebar-logo-img').src = base64 || "";
      const logoUploadDiv = document.querySelector('.logo-upload');
      if (base64) {
        logoUploadDiv.classList.add('hide');
      } else {
        logoUploadDiv.classList.remove('hide'); 
      }
    }
    window.addEventListener('DOMContentLoaded', function () {
      setLogoBase64(getLogoBase64());
    });
    document.addEventListener('DOMContentLoaded', function () {
      document.getElementById('logo-upload-input').addEventListener('change', function (e) {
        const file = this.files[0];
        if (!file) return;
        if (!file.type.match(/image\/(png|jpeg)/)) {
          alert("Envie uma imagem PNG ou JPG.");
          return;
        }
        if (file.size > 200 * 1024) {
          alert("Imagem deve ter at√© 200kb.");
          return;
        }
        const reader = new FileReader();
        reader.onload = function (ev) {
          setLogoBase64(ev.target.result);
          notificar("Logo atualizada!");
        };
        reader.readAsDataURL(file);
      });
    });

    // ====== NAVEGA√á√ÉO ======
    function nav(page) {
      document.getElementById('main-title').textContent = ({
        orcamentos: "Or√ßamentos",
        os: "Ordens de Servi√ßo",
        clientes: "Clientes",
        estoque: "Estoque",
        relatorio: "Relat√≥rio de OS"
      })[page];
      document.querySelectorAll('.sidebar button').forEach(btn => btn.classList.remove('active'));
      document.getElementById('nav-' + page).classList.add('active');
      document.querySelectorAll('main section').forEach(sec => sec.classList.add('hide'));
      document.getElementById('page-' + page).classList.remove('hide');
      hideOrcamentoForm(); hideClienteForm(); hideOSForm(); hideEstoqueForm();
      if (page === "clientes") renderClientes();
      if (page === "os") renderOS();
      if (page === "orcamentos") renderOrcamentos();
      if (page === "estoque") renderEstoque();
      if (page === "relatorio") renderRelatorio();
    }

    // ====== CONTROLE DE ESTOQUE ======
    function renderEstoque() {
      let tbody = document.getElementById('estoque-table');
      tbody.innerHTML = '';
      if (!window.estoque || !window.estoque.length) {
        tbody.innerHTML = `<tr><td colspan="6"><em>Nenhuma pe√ßa cadastrada no estoque.</em></td></tr>`;
        return;
      }
      window.estoque.forEach((peca, i) => {
        tbody.innerHTML += `
          <tr>
            <td>${peca.nome}</td>
            <td>${peca.codigo}</td>
            <td>${peca.desc || ''}</td>
            <td>
              ${peca.qtd}
              <button class="btn btn-sm btn-outline" title="Entrada" onclick="alterarQtdEstoque(${peca.id},1)">+</button>
              <button class="btn btn-sm btn-outline" title="Sa√≠da" onclick="alterarQtdEstoque(${peca.id},-1)" ${peca.qtd<=0?'disabled':''}>-</button>
            </td>
            <td>R$ ${parseFloat(peca.preco).toLocaleString('pt-BR')}</td>
            <td>
              <button class="btn btn-sm" onclick="editarPecaEstoque(${peca.id})">Editar</button>
              <button class="btn btn-sm btn-danger" onclick="excluirPecaEstoque(${peca.id})">Excluir</button>
            </td>
          </tr>
        `;
      });
    }
    function showEstoqueForm(editId) {
      document.getElementById('estoque-form-wrap').classList.remove('hide');
      document.getElementById('estoque-form-title').textContent = editId ? "Editar Pe√ßa" : "Nova Pe√ßa";
      document.getElementById('estoque-form-id').value = editId || '';
      if (editId) {
        let p = window.estoque.find(e => e.id == editId);
        document.getElementById('estoque-form-nome').value = p.nome;
        document.getElementById('estoque-form-codigo').value = p.codigo;
        document.getElementById('estoque-form-desc').value = p.desc || '';
        document.getElementById('estoque-form-qtd').value = p.qtd;
        document.getElementById('estoque-form-preco').value = p.preco;
      } else {
        document.getElementById('estoque-form-nome').value = '';
        document.getElementById('estoque-form-codigo').value = '';
        document.getElementById('estoque-form-desc').value = '';
        document.getElementById('estoque-form-qtd').value = '';
        document.getElementById('estoque-form-preco').value = '';
      }
    }
    function hideEstoqueForm() {
      document.getElementById('estoque-form-wrap').classList.add('hide');
    }
    function salvarPecaEstoque(e) {
      e.preventDefault();
      let id = document.getElementById('estoque-form-id').value;
      let nome = document.getElementById('estoque-form-nome').value.trim();
      let codigo = document.getElementById('estoque-form-codigo').value.trim();
      let desc = document.getElementById('estoque-form-desc').value.trim();
      let qtd = parseInt(document.getElementById('estoque-form-qtd').value);
      let preco = parseFloat(document.getElementById('estoque-form-preco').value);

      if (!nome || !codigo || isNaN(qtd) || isNaN(preco)) {
        notificar("Preencha todos os campos obrigat√≥rios.");
        return;
      }
      if (id) {
        let p = window.estoque.find(e => e.id == id);
        Object.assign(p, { nome, codigo, desc, qtd, preco });
        notificar("Pe√ßa atualizada!");
      } else {
        window.estoque.push({
          id: gerarId(window.estoque),
          nome, codigo, desc, qtd, preco
        });
        notificar("Pe√ßa cadastrada!");
      }
      saveData();
      hideEstoqueForm();
      renderEstoque();
    }
    function editarPecaEstoque(id) {
      showEstoqueForm(id);
    }
    function excluirPecaEstoque(id) {
      if (confirm("Excluir esta pe√ßa do estoque?")) {
        window.estoque = window.estoque.filter(e => e.id != id);
        saveData();
        renderEstoque();
      }
    }
    function alterarQtdEstoque(id, delta) {
      let p = window.estoque.find(e => e.id == id);
      if (!p) return;
      if (delta < 0 && p.qtd <= 0) return;
      p.qtd += delta;
      if (p.qtd < 0) p.qtd = 0;
      saveData();
      renderEstoque();
    }

    // ====== AUTOCOMPLETE DE PE√áA DO ESTOQUE ======
    function setupAutocompleteEstoque(inputId, valorId, qtdId) {
      let input = document.getElementById(inputId);
      let valor = document.getElementById(valorId);
      let qtd = document.getElementById(qtdId);

      input.addEventListener("input", function() {
        closeAllLists();
        let val = this.value;
        if (!val) return false;
        let list, item, count = 0;
        list = document.createElement("div");
        list.setAttribute("id", this.id + "-autocomplete-list");
        list.setAttribute("class", "autocomplete-items");
        this.parentNode.appendChild(list);
        window.estoque.forEach((peca) => {
          if (
            (peca.nome && peca.nome.toUpperCase().includes(val.toUpperCase())) ||
            (peca.codigo && peca.codigo.toUpperCase().includes(val.toUpperCase()))
          ) {
            item = document.createElement("div");
            item.innerHTML = `<b>${peca.nome}</b> - c√≥d: ${peca.codigo} | R$ ${parseFloat(peca.preco).toLocaleString('pt-BR')} | Estoque: ${peca.qtd}`;
            item.addEventListener("click", function(e) {
              input.value = peca.nome;
              valor.value = peca.preco;
              qtd.value = 1;
              closeAllLists();
            });
            list.appendChild(item);
            count++;
          }
        });
        if (!count) {
          item = document.createElement("div");
          item.innerHTML = `<em>Nenhuma pe√ßa do estoque encontrada</em>`;
          list.appendChild(item);
        }
      });
      document.addEventListener("click", function(e) { closeAllLists(e.target); });
      function closeAllLists(elmnt) {
        let x = document.getElementsByClassName("autocomplete-items");
        for (let i = 0; i < x.length; i++) {
          if (elmnt != x[i] && elmnt != input) {
            x[i].parentNode.removeChild(x[i]);
          }
        }
      }
    }

    // ====== ITENS DO OR√áAMENTO (INTEGRADO AO ESTOQUE) ======
    let orcamentoItensTmp = [];
    setupAutocompleteEstoque("orc-item-nome", "orc-item-valor", "orc-item-qtd");
    function adicionarItemOrcamento() {
      const nome = document.getElementById('orc-item-nome').value.trim();
      const valor = parseFloat(document.getElementById('orc-item-valor').value);
      let qtd = parseInt(document.getElementById('orc-item-qtd').value)||1;
      let estoqueId = null;
      let estoqueMatch = window.estoque.find(p => p.nome.toUpperCase() === nome.toUpperCase());
      if (estoqueMatch) {
        estoqueId = estoqueMatch.id;
        if (qtd > estoqueMatch.qtd) {
          notificar("Qtd maior que dispon√≠vel no estoque!");
          return;
        }
      }
      if (nome && valor && valor > 0 && qtd>0) {
        orcamentoItensTmp.push({ nome, valor, qtd, estoqueId });
        document.getElementById('orc-item-nome').value = '';
        document.getElementById('orc-item-valor').value = '';
        document.getElementById('orc-item-qtd').value = '';
        renderOrcamentoItens();
      }
    }
    function removerItemOrcamento(idx) {
      orcamentoItensTmp.splice(idx, 1);
      renderOrcamentoItens();
    }
    function renderOrcamentoItens() {
      const div = document.getElementById('orc-itens-list');
      if (!orcamentoItensTmp.length) {
        div.innerHTML = "<em>Nenhum item adicionado</em>";
        document.getElementById('orc-form-valor').value = '';
        return;
      }
      let total = 0;
      div.innerHTML = '<table style="width:100%;font-size:.97em;"><tbody>' +
        orcamentoItensTmp.map((item, i) => `
        <tr>
          <td>${item.nome}${item.estoqueId ? ' <span style="color:#009688;font-size:.9em;">[Estoque]</span>' : ''}</td>
          <td style="width:70px;">Qtd: ${item.qtd||1}</td>
          <td style="width:80px;">R$ ${item.valor.toLocaleString('pt-BR')}</td>
          <td style="width:60px;">
            <button type="button" class="btn btn-sm btn-danger" onclick="removerItemOrcamento(${i})">Remover</button>
          </td>
        </tr>
      `).join("") +
        '</tbody></table>';
      total = orcamentoItensTmp.reduce((acc, it) => acc + (it.valor*(it.qtd||1)), 0);
      document.getElementById('orc-form-valor').value = total.toFixed(2);
    }

    // ====== ITENS DA OS (INTEGRADO AO ESTOQUE) ======
    let osItensTmp = [];
    setupAutocompleteEstoque("os-item-nome", "os-item-valor", "os-item-qtd");
    function adicionarItemOS() {
      const nome = document.getElementById('os-item-nome').value.trim();
      const valor = parseFloat(document.getElementById('os-item-valor').value);
      let qtd = parseInt(document.getElementById('os-item-qtd').value)||1;
      let estoqueId = null;
      let estoqueMatch = window.estoque.find(p => p.nome.toUpperCase() === nome.toUpperCase());
      if (estoqueMatch) {
        estoqueId = estoqueMatch.id;
        if (qtd > estoqueMatch.qtd) {
          notificar("Qtd maior que dispon√≠vel no estoque!");
          return;
        }
      }
      if (nome && valor && valor > 0 && qtd>0) {
        osItensTmp.push({ nome, valor, qtd, estoqueId });
        document.getElementById('os-item-nome').value = '';
        document.getElementById('os-item-valor').value = '';
        document.getElementById('os-item-qtd').value = '';
        renderOSItens();
      }
    }
    function removerItemOS(idx) {
      osItensTmp.splice(idx,1);
      renderOSItens();
    }
    function renderOSItens() {
      const div = document.getElementById('os-itens-list');
      if (!osItensTmp.length) {
        div.innerHTML = "<em>Nenhum item adicionado</em>";
        document.getElementById('os-form-valor').value = '';
        return;
      }
      let total = 0;
      div.innerHTML = '<table style="width:100%;font-size:.97em;"><tbody>' +
        osItensTmp.map((item, i) => `
        <tr>
          <td>${item.nome}${item.estoqueId ? ' <span style="color:#009688;font-size:.9em;">[Estoque]</span>' : ''}</td>
          <td style="width:70px;">Qtd: ${item.qtd||1}</td>
          <td style="width:80px;">R$ ${item.valor.toLocaleString('pt-BR')}</td>
          <td style="width:60px;">
            <button type="button" class="btn btn-sm btn-danger" onclick="removerItemOS(${i})">Remover</button>
          </td>
        </tr>
      `).join("") +
        '</tbody></table>';
      total = osItensTmp.reduce((acc, it) => acc + (it.valor*(it.qtd||1)), 0);
      document.getElementById('os-form-valor').value = total.toFixed(2);
    }

    // ====== OR√áAMENTOS ======
    function renderOrcamentos() {
      let tbody = document.getElementById('orc-table');
      tbody.innerHTML = '';
      window.orcList.forEach(or => {
        let cli = getClienteById(or.clienteId);
        let veic = cli && cli.veiculos[or.veiculoIdx];
        tbody.innerHTML += `<tr>
        <td>${or.id}</td>
        <td>${cli ? cli.nome : '-'}</td>
        <td>${veic ? veic.marca + " (" + veic.placa + ")" : '-'}</td>
        <td>
          <ul style="padding-left:1em;margin:0;">
            ${or.itens ? or.itens.map(it => `<li>${it.nome}${it.estoqueId ? ' <span style="color:#009688;font-size:.9em;">[Estoque]</span>' : ''} - Qtd: ${it.qtd||1} - R$ ${(it.valor).toLocaleString('pt-BR')}</li>`).join("") : "-"}
          </ul>
        </td>
        <td>R$ ${(+or.valor).toLocaleString('pt-BR')}</td>
        <td>${or.status}</td>
        <td>${formatarData(or.validade)}</td>
        <td>
          <button class="btn btn-sm" onclick="editarOrcamento(${or.id})">Editar</button>
          <button class="btn btn-sm btn-danger" onclick="excluirOrcamento(${or.id})">Excluir</button>
          <button class="btn btn-sm btn-success" onclick="baixarOrcamentoPDF(${or.id})">PDF</button>
          ${or.status === "Aprovado"
            ? `<button class="btn btn-sm btn-success" onclick="gerarOSdeOrcamento(${or.id})">Gerar OS</button>`
            : ""}
        </td>
      </tr>`;
      });
    }

    // GERAR OS AUTOMATICAMENTE DE UM OR√áAMENTO APROVADO (d√° baixa no estoque)
    function gerarOSdeOrcamento(orcId) {
      const orc = getOrcById(orcId);
      if (!orc) return;
      // Verifica se tem pe√ßa do estoque e quantidade suficiente
      if (orc.itens) {
        for (let it of orc.itens) {
          if (it.estoqueId) {
            let est = window.estoque.find(e => e.id == it.estoqueId);
            if (!est || est.qtd < (it.qtd||1)) {
              notificar(`Pe√ßa "${it.nome}" sem estoque suficiente!`);
              return;
            }
          }
        }
      }
      // D√° baixa
      if (orc.itens) {
        for (let it of orc.itens) {
          if (it.estoqueId) {
            let est = window.estoque.find(e => e.id == it.estoqueId);
            est.qtd -= (it.qtd||1);
            if (est.qtd < 0) est.qtd = 0;
          }
        }
        saveData();
      }
      const clienteId = orc.clienteId;
      const veiculoIdx = orc.veiculoIdx;
      const itens = orc.itens ? JSON.parse(JSON.stringify(orc.itens)) : [];
      const valor = orc.valor;
      const descricao = itens.map(it => it.nome).join(', ');
      const hoje = new Date().toISOString().split('T')[0];
      const pagamento = "Dinheiro";
      const entrada = hoje;
      const saida = hoje;
      const status = "Em andamento";
      window.osList.push({
        id: gerarId(window.osList),
        clienteId,
        veiculoIdx,
        itens,
        valor,
        pagamento,
        entrada,
        saida,
        status
      });
      saveData();
      renderOS();
      renderRelatorio();
      renderEstoque();
      notificar("OS gerada automaticamente! Baixa no estoque realizada.");
    }

    function showOrcamentoForm(editId) {
      document.getElementById('orc-form-wrap').classList.remove('hide');
      document.getElementById('orc-form-title').textContent = editId ? "Editar Or√ßamento" : "Novo Or√ßamento";
      document.getElementById('orc-form-id').value = editId || '';
      popularClientesOrcamento();
      if (editId) {
        const o = getOrcById(editId);
        document.getElementById('orc-form-cliente').value = o.clienteId;
        popularVeiculosOrcamento();
        document.getElementById('orc-form-veiculo').value = o.veiculoIdx;
        orcamentoItensTmp = o.itens ? JSON.parse(JSON.stringify(o.itens)) : [];
        renderOrcamentoItens();
        document.getElementById('orc-form-status').value = o.status;
        document.getElementById('orc-form-validade').value = o.validade;
        document.getElementById('orc-form-obs').value = o.obs || '';
      } else {
        document.getElementById('orc-form-cliente').selectedIndex = 0;
        popularVeiculosOrcamento();
        document.getElementById('orc-form-veiculo').selectedIndex = 0;
        orcamentoItensTmp = [];
        renderOrcamentoItens();
        document.getElementById('orc-form-status').selectedIndex = 0;
        document.getElementById('orc-form-validade').value = '';
        document.getElementById('orc-form-obs').value = '';
      }
    }
    function hideOrcamentoForm() {
      document.getElementById('orc-form-wrap').classList.add('hide');
    }
    function salvarOrcamento(e) {
      e.preventDefault();
      let id = document.getElementById('orc-form-id').value;
      let clienteId = +document.getElementById('orc-form-cliente').value;
      let veiculoIdx = +document.getElementById('orc-form-veiculo').value;
      let itens = JSON.parse(JSON.stringify(orcamentoItensTmp));
      let valor = +document.getElementById('orc-form-valor').value;
      let status = document.getElementById('orc-form-status').value;
      let validade = document.getElementById('orc-form-validade').value;
      let obs = document.getElementById('orc-form-obs').value;
      if (!clienteId || isNaN(veiculoIdx) || !valor || !validade || !itens.length) {
        notificar("Preencha todos os campos obrigat√≥rios e ao menos um item!");
        return;
      }
      if (id) {
        let o = getOrcById(+id);
        Object.assign(o, { clienteId, veiculoIdx, itens, valor, status, validade, obs });
        notificar("Or√ßamento atualizado!");
      } else {
        window.orcList.push({ id: gerarId(window.orcList), clienteId, veiculoIdx, itens, valor, status, validade, obs });
        notificar("Or√ßamento cadastrado!");
      }
      saveData(); hideOrcamentoForm(); renderOrcamentos();
    }
    function excluirOrcamento(id) {
      if (confirm('Excluir este or√ßamento?')) {
        window.orcList = window.orcList.filter(o => o.id != id);
        saveData(); renderOrcamentos();
      }
    }
    function editarOrcamento(id) { showOrcamentoForm(id); }
    function popularClientesOrcamento() {
      let select = document.getElementById('orc-form-cliente');
      select.innerHTML = '<option value="">Selecione</option>';
      window.clientes.forEach((cli, idx) => {
        let op = document.createElement('option');
        op.value = cli.id;
        op.textContent = cli.nome;
        select.appendChild(op);
      });
      popularVeiculosOrcamento();
    }
    function popularVeiculosOrcamento() {
      let cliId = document.getElementById('orc-form-cliente').value;
      let select = document.getElementById('orc-form-veiculo');
      let cli = getClienteById(cliId);
      select.innerHTML = '<option value="">Selecione um cliente primeiro</option>';
      if (cli && cli.veiculos.length) {
        select.innerHTML = '';
        cli.veiculos.forEach((v, i) => {
          let op = document.createElement('option');
          op.value = i;
          op.textContent = v.marca + " (" + v.placa + ")";
          select.appendChild(op);
        });
      }
    }

    // ====== OS (INTEGRADA AO ESTOQUE) ======
    function renderOS() {
      let tbody = document.getElementById('os-table');
      tbody.innerHTML = '';
      window.osList.forEach(os => {
        let cli = getClienteById(os.clienteId);
        let veic = cli && cli.veiculos[os.veiculoIdx];
        tbody.innerHTML += `<tr>
        <td>${os.id}</td>
        <td>${cli ? cli.nome : '-'}</td>
        <td>${veic ? veic.marca + " (" + veic.placa + ")" : '-'}</td>
        <td>
          <ul style="padding-left:1em;margin:0;">
            ${os.itens ? os.itens.map(it => `<li>${it.nome}${it.estoqueId ? ' <span style="color:#009688;font-size:.9em;">[Estoque]</span>' : ''} - Qtd: ${it.qtd||1} - R$ ${(it.valor).toLocaleString('pt-BR')}</li>`).join("") : os.descricao || "-"}
          </ul>
        </td>
        <td>R$ ${(+os.valor).toLocaleString('pt-BR')}</td>
        <td>${os.pagamento || '-'}</td>
        <td>${os.status || '-'}</td>
        <td>${formatarData(os.entrada)}</td>
        <td>${formatarData(os.saida)}</td>
        <td>
          <button class="btn btn-sm" onclick="editarOS(${os.id})">Editar</button>
          <button class="btn btn-sm btn-danger" onclick="excluirOS(${os.id})">Excluir</button>
        </td>
      </tr>`;
      });
    }
    function showOSForm(editId) {
      document.getElementById('os-form-wrap').classList.remove('hide');
      document.getElementById('os-form-title').textContent = editId ? "Editar OS" : "Nova Ordem de Servi√ßo";
      document.getElementById('os-form-id').value = editId || '';
      popularClientesOS();
      if (editId) {
        const o = getOSById(editId);
        document.getElementById('os-form-cliente').value = o.clienteId;
        popularVeiculosOS();
        document.getElementById('os-form-veiculo').value = o.veiculoIdx;
        osItensTmp = o.itens ? JSON.parse(JSON.stringify(o.itens)) : [];
        renderOSItens();
        document.getElementById('os-form-pagamento').value = o.pagamento;
        document.getElementById('os-form-entrada').value = o.entrada;
        document.getElementById('os-form-saida').value = o.saida;
        document.getElementById('os-form-status').value = o.status;
      } else {
        document.getElementById('os-form-cliente').selectedIndex = 0;
        popularVeiculosOS();
        document.getElementById('os-form-veiculo').selectedIndex = 0;
        osItensTmp = [];
        renderOSItens();
        document.getElementById('os-form-pagamento').selectedIndex = 0;
        document.getElementById('os-form-entrada').value = '';
        document.getElementById('os-form-saida').value = '';
        document.getElementById('os-form-status').selectedIndex = 0;
      }
    }
    function hideOSForm() {
      document.getElementById('os-form-wrap').classList.add('hide');
    }
    function salvarOS(e) {
      e.preventDefault();
      let id = document.getElementById('os-form-id').value;
      let clienteId = +document.getElementById('os-form-cliente').value;
      let veiculoIdx = +document.getElementById('os-form-veiculo').value;
      let itens = JSON.parse(JSON.stringify(osItensTmp));
      let valor = +document.getElementById('os-form-valor').value;
      let pagamento = document.getElementById('os-form-pagamento').value;
      let entrada = document.getElementById('os-form-entrada').value;
      let saida = document.getElementById('os-form-saida').value;
      let status = document.getElementById('os-form-status').value;

      // Verifica estoque antes de salvar
      if (itens) {
        for (let it of itens) {
          if (it.estoqueId) {
            let est = window.estoque.find(e => e.id == it.estoqueId);
            if (!est || est.qtd < (it.qtd||1)) {
              notificar(`Pe√ßa "${it.nome}" sem estoque suficiente!`);
              return;
            }
          }
        }
      }

      if (!clienteId || isNaN(veiculoIdx) || !valor || !pagamento || !entrada || !saida || !status) return;
      if (id) {
        let o = getOSById(+id);
        // Reverte as pe√ßas do estoque do registro anterior
        if (o.itens) {
          for (let it of o.itens) {
            if (it.estoqueId) {
              let est = window.estoque.find(e => e.id == it.estoqueId);
              if (est) est.qtd += (it.qtd||1);
            }
          }
        }
        Object.assign(o, { clienteId, veiculoIdx, itens, valor, pagamento, entrada, saida, status });
        notificar("OS atualizada!");
      } else {
        window.osList.push({ id: gerarId(window.osList), clienteId, veiculoIdx, itens, valor, pagamento, entrada, saida, status });
        notificar("OS cadastrada!");
      }
      // D√° baixa no estoque das pe√ßas inclu√≠das
      if (itens) {
        for (let it of itens) {
          if (it.estoqueId) {
            let est = window.estoque.find(e => e.id == it.estoqueId);
            if (est) { est.qtd -= (it.qtd||1); if (est.qtd < 0) est.qtd = 0; }
          }
        }
        saveData();
      }
      saveData(); hideOSForm(); renderOS(); renderEstoque(); renderRelatorio();
    }
    function excluirOS(id) {
      if (confirm('Excluir esta OS?')) {
        // Devolve as pe√ßas do estoque
        let o = getOSById(id);
        if (o && o.itens) {
          for (let it of o.itens) {
            if (it.estoqueId) {
              let est = window.estoque.find(e => e.id == it.estoqueId);
              if (est) est.qtd += (it.qtd||1);
            }
          }
        }
        window.osList = window.osList.filter(o => o.id != id);
        saveData(); renderOS(); renderEstoque(); renderRelatorio();
      }
    }
    function editarOS(id) { showOSForm(id); }
    function popularClientesOS() {
      let select = document.getElementById('os-form-cliente');
      select.innerHTML = '<option value="">Selecione</option>';
      window.clientes.forEach((cli) => {
        let op = document.createElement('option');
        op.value = cli.id;
        op.textContent = cli.nome;
        select.appendChild(op);
      });
      popularVeiculosOS();
    }
    function popularVeiculosOS() {
      let cliId = document.getElementById('os-form-cliente').value;
      let select = document.getElementById('os-form-veiculo');
      let cli = getClienteById(cliId);
      select.innerHTML = '<option value="">Selecione um cliente primeiro</option>';
      if (cli && cli.veiculos.length) {
        select.innerHTML = '';
        cli.veiculos.forEach((v, i) => {
          let op = document.createElement('option');
          op.value = i;
          op.textContent = v.marca + " (" + v.placa + ")";
          select.appendChild(op);
        });
      }
    }
    // --- Clientes ---
    let veiculosTmp = [];
    function renderClientes() {
      let tbody = document.getElementById('clientes-table');
      tbody.innerHTML = '';
      window.clientes.forEach((cli, i) => {
        let veiculos = cli.veiculos.map((v, vi) =>
          `<div>
          ${v.marca} (${v.placa}, ${v.ano}${v.cor ? ", " + v.cor : ""})
          <button class="btn btn-sm btn-outline" onclick="editarVeiculo(${cli.id},${vi})">Editar</button>
          <button class="btn btn-sm btn-danger" onclick="excluirVeiculo(${cli.id},${vi})">Remover</button>
        </div>`
        ).join("");
        tbody.innerHTML += `<tr>
        <td>${cli.nome}</td>
        <td>${cli.telefone}</td>
        <td>${cli.email}</td>
        <td>${veiculos || '<em>Nenhum ve√≠culo</em>'}</td>
        <td>
          <button class="btn btn-sm" onclick="editarCliente(${cli.id})">Editar</button>
          <button class="btn btn-sm btn-danger" onclick="excluirCliente(${cli.id})">Excluir</button>
        </td>
      </tr>`;
      });
    }
    function showClienteForm(editId) {
      document.getElementById('cliente-form-wrap').classList.remove('hide');
      document.getElementById('cliente-form-title').textContent = editId ? "Editar Cliente" : "Novo Cliente";
      document.getElementById('cli-id').value = editId || '';
      if (editId) {
        let cli = getClienteById(editId);
        document.getElementById('cli-nome').value = cli.nome;
        document.getElementById('cli-telefone').value = cli.telefone;
        document.getElementById('cli-email').value = cli.email;
        veiculosTmp = JSON.parse(JSON.stringify(cli.veiculos));
        renderVeiculosAdicionados();
      } else {
        document.getElementById('cli-nome').value = '';
        document.getElementById('cli-telefone').value = '';
        document.getElementById('cli-email').value = '';
        veiculosTmp = [];
        renderVeiculosAdicionados();
      }
    }
    function hideClienteForm() {
      document.getElementById('cliente-form-wrap').classList.add('hide');
    }
    function adicionarVeiculo() {
      let marca = document.getElementById('cli-veiculo-marca').value.trim();
      let placa = document.getElementById('cli-veiculo-placa').value.trim();
      let ano = document.getElementById('cli-veiculo-ano').value.trim();
      let cor = document.getElementById('cli-veiculo-cor').value.trim();
      if (marca && placa && ano) {
        veiculosTmp.push({ marca, placa, ano, cor });
        renderVeiculosAdicionados();
        document.getElementById('cli-veiculo-marca').value = '';
        document.getElementById('cli-veiculo-placa').value = '';
        document.getElementById('cli-veiculo-ano').value = '';
        document.getElementById('cli-veiculo-cor').value = '';
      }
    }
    function removerVeiculo(idx) {
      veiculosTmp.splice(idx, 1);
      renderVeiculosAdicionados();
    }
    function renderVeiculosAdicionados() {
      let div = document.getElementById('veiculos-adicionados');
      if (veiculosTmp.length === 0) {
        div.innerHTML = "<em>Nenhum ve√≠culo adicionado</em>";
        return;
      }
      div.innerHTML = veiculosTmp.map((v, i) =>
        `<div>
        ${v.marca} (${v.placa}, ${v.ano}${v.cor ? ", " + v.cor : ""})
        <button type="button" class="btn btn-sm btn-danger" onclick="removerVeiculo(${i})">Remover</button>
      </div>`
      ).join("");
    }
    function salvarCliente(e) {
      e.preventDefault();
      let id = document.getElementById('cli-id').value;
      let nome = document.getElementById('cli-nome').value.trim();
      let telefone = document.getElementById('cli-telefone').value.trim();
      let email = document.getElementById('cli-email').value.trim();
      if (nome && veiculosTmp.length > 0) {
        if (id) {
          let cli = getClienteById(+id);
          Object.assign(cli, { nome, telefone, email, veiculos: JSON.parse(JSON.stringify(veiculosTmp)) });
          notificar("Cliente atualizado!");
        } else {
          window.clientes.push({ id: gerarId(window.clientes), nome, telefone, email, veiculos: JSON.parse(JSON.stringify(veiculosTmp)) });
          notificar("Cliente cadastrado!");
        }
        saveData(); hideClienteForm(); renderClientes();
      } else {
        notificar("Informe nome e ao menos um ve√≠culo.");
      }
    }
    function editarCliente(id) { showClienteForm(id); }
    function excluirCliente(id) {
      if (confirm('Excluir este cliente (e todos seus ve√≠culos)?')) {
        window.clientes = window.clientes.filter(c => c.id != id);
        saveData(); renderClientes();
      }
    }
    function editarVeiculo(cliId, veicIdx) {
      let cli = getClienteById(cliId);
      let v = cli.veiculos[veicIdx];
      let marca = prompt("Marca/Modelo:", v.marca);
      let placa = prompt("Placa:", v.placa);
      let ano = prompt("Ano:", v.ano);
      let cor = prompt("Cor:", v.cor || "");
      if (marca && placa && ano) {
        Object.assign(v, { marca, placa, ano, cor });
        saveData(); renderClientes();
      }
    }
    function excluirVeiculo(cliId, veicIdx) {
      let cli = getClienteById(cliId);
      if (confirm('Remover este ve√≠culo?')) {
        cli.veiculos.splice(veicIdx, 1);
        saveData(); renderClientes();
      }
    }
    // --- Relat√≥rio OS ---
    function renderRelatorio() {
      let filtro = document.getElementById('filtro-pagamento').value;
      let tbody = document.getElementById('relatorio-table');
      tbody.innerHTML = '';
      let total = 0;
      let count = 0;
      window.osList.forEach(os => {
        if (filtro && os.pagamento !== filtro) return;
        let cli = getClienteById(os.clienteId);
        let veic = cli && cli.veiculos[os.veiculoIdx];
        tbody.innerHTML += `
        <tr>
          <td>${os.id}</td>
          <td>${cli ? cli.nome : '-'}</td>
          <td>${veic ? veic.marca + " (" + veic.placa + ")" + (veic.cor ? ", " + veic.cor : "") : '-'}</td>
          <td>R$ ${(+os.valor).toLocaleString('pt-BR')}</td>
          <td>${os.pagamento || '-'}</td>
          <td>${os.status || '-'}</td>
          <td>${formatarData(os.entrada)}</td>
          <td>${formatarData(os.saida)}</td>
        </tr>
      `;
        total += +os.valor;
        count++;
      });
      if (count === 0) {
        tbody.innerHTML = '<tr><td colspan="8"><em>Nenhuma OS encontrada para o filtro</em></td></tr>';
      } else {
        tbody.innerHTML += `
        <tr class="total-row">
          <td colspan="3" style="text-align:right;">Total</td>
          <td colspan="5"><b>R$ ${total.toLocaleString('pt-BR')}</b></td>
        </tr>
      `;
      }
    }
    function baixarPDF() {
      let filtro = document.getElementById('filtro-pagamento').value;
      let rows = [];
      let total = 0;
      window.osList.forEach(os => {
        if (filtro && os.pagamento !== filtro) return;
        let cli = getClienteById(os.clienteId);
        let veic = cli && cli.veiculos[os.veiculoIdx];
        rows.push([
          os.id,
          cli ? cli.nome : '-',
          veic ? veic.marca + " (" + veic.placa + ")" + (veic.cor ? ", " + veic.cor : "") : '-',
          "R$ " + (+os.valor).toLocaleString('pt-BR'),
          os.pagamento || '-',
          os.status || '-',
          formatarData(os.entrada),
          formatarData(os.saida)
        ]);
        total += +os.valor;
      });
      if (rows.length === 0) {
        notificar("Nenhuma OS para exportar!");
        return;
      }
      rows.push([
        { content: 'Total', colSpan: 3, styles: { halign: 'right' } },
        { content: "R$ " + total.toLocaleString('pt-BR'), colSpan: 5, styles: { halign: 'left', fontStyle: 'bold' } }
      ]);
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Relat√≥rio de Ordens de Servi√ßo", 14, 18);
      if (filtro) doc.text("Filtro: " + filtro, 14, 26);
      doc.autoTable({
        head: [[
          '#', 'Cliente', 'Ve√≠culo', 'Valor', 'Forma Pagamento', 'Status', 'Entrada', 'Sa√≠da'
        ]],
        body: rows,
        startY: filtro ? 30 : 26,
        styles: { fontSize: 9 },
        headStyles: { fillColor: [0, 121, 107] }
      });
      doc.save('relatorio-os.pdf');
    }
    function formatarData(dt) {
      if (!dt) return "";
      let d = new Date(dt);
      if (isNaN(d.getTime())) return dt;
      let dia = ("0" + d.getDate()).slice(-2);
      let mes = ("0" + (d.getMonth() + 1)).slice(-2);
      let ano = d.getFullYear();
      return `${dia}/${mes}/${ano}`;
    }

    function getClienteById(id) { return window.clientes.find(c => c.id == id); }
    function getOrcById(id) { return window.orcList.find(o => o.id == id); }
    function getOSById(id) { return window.osList.find(o => o.id == id); }

    // Inicializa√ß√£o
    loadData();
    nav('orcamentos');
    renderClientes();
    renderOS();
    renderOrcamentos();
    renderEstoque();

  </script>


</body></html>
